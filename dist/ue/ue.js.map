{"version":3,"file":"ue.js","sources":["../../src/scripts/editor-support-rte.js","../../src/scripts/editor-support.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable no-cond-assign */\n/* eslint-disable import/prefer-default-export */\n\n// group editable texts in single wrappers if applicable.\n// this script should execute after script.js but before the the universal editor cors script\n// and any block being loaded\n\nexport function decorateRichtext(container = document) {\n  function deleteInstrumentation(element) {\n    delete element.dataset.richtextResource;\n    delete element.dataset.richtextProp;\n    delete element.dataset.richtextFilter;\n    delete element.dataset.richtextLabel;\n  }\n\n  let element;\n  while (element = container.querySelector('[data-richtext-prop]:not(div)')) {\n    const {\n      richtextResource,\n      richtextProp,\n      richtextFilter,\n      richtextLabel,\n    } = element.dataset;\n\n    deleteInstrumentation(element);\n    const siblings = [];\n    let sibling = element;\n    while (sibling = sibling.nextElementSibling) {\n      if (sibling.dataset.richtextResource === richtextResource\n        && sibling.dataset.richtextProp === richtextProp) {\n        deleteInstrumentation(sibling);\n        siblings.push(sibling);\n      } else break;\n    }\n\n    let orphanElements;\n    if (richtextResource && richtextProp) {\n      orphanElements = document.querySelectorAll(`[data-richtext-id=\"${richtextResource}\"][data-richtext-prop=\"${richtextProp}\"]`);\n    } else {\n      const editable = element.closest('[data-aue-resource]');\n      if (editable) {\n        orphanElements = editable.querySelectorAll(`:scope > :not([data-aue-resource]) [data-richtext-prop=\"${richtextProp}\"]`);\n      } else {\n        console.warn(`Editable parent not found or richtext property ${richtextProp}`);\n        return;\n      }\n    }\n\n    if (orphanElements.length) {\n      console.warn('Found orphan elements of a richtext, that were not consecutive siblings of '\n        + 'the first paragraph', orphanElements);\n      orphanElements.forEach((orphanElement) => deleteInstrumentation(orphanElement));\n    } else {\n      const group = document.createElement('div');\n      if (richtextResource) {\n        group.dataset.aueResource = richtextResource;\n        group.dataset.aueBehavior = 'component';\n      }\n      if (richtextProp) group.dataset.aueProp = richtextProp;\n      if (richtextLabel) group.dataset.aueLabel = richtextLabel;\n      if (richtextFilter) group.dataset.aueFilter = richtextFilter;\n      group.dataset.aueType = 'richtext';\n      element.replaceWith(group);\n      group.append(element, ...siblings);\n    }\n  }\n}\n\n// in cases where the block decoration is not done in one synchronous iteration we need to listen\n// for new richtext-instrumented elements\nconst observer = new MutationObserver(() => decorateRichtext());\nobserver.observe(document, { attributeFilter: ['data-richtext-prop'], subtree: true });\n\ndecorateRichtext();\n","import {\n  decorateBlock,\n  decorateBlocks,\n  decorateButtons,\n  decorateIcons,\n  decorateSections,\n  loadBlock,\n  loadSections,\n} from './aem.js';\nimport { decorateRichtext } from './editor-support-rte.js';\nimport { decorateMain } from './scripts.js';\n\nasync function applyChanges(event) {\n  // redecorate default content and blocks on patches (in the properties rail)\n  const { detail } = event;\n\n  const resource = detail?.request?.target?.resource // update, patch components\n    || detail?.request?.target?.container?.resource // update, patch, add to sections\n    || detail?.request?.to?.container?.resource; // move in sections\n  if (!resource) return false;\n  const updates = detail?.response?.updates;\n  if (!updates.length) return false;\n  const { content } = updates[0];\n  if (!content) return false;\n\n  const parsedUpdate = new DOMParser().parseFromString(content, 'text/html');\n  const element = document.querySelector(`[data-aue-resource=\"${resource}\"]`);\n\n  if (element) {\n    if (element.matches('main')) {\n      const newMain = parsedUpdate.querySelector(`[data-aue-resource=\"${resource}\"]`);\n      newMain.style.display = 'none';\n      element.insertAdjacentElement('afterend', newMain);\n      decorateMain(newMain);\n      decorateRichtext(newMain);\n      await loadSections(newMain);\n      element.remove();\n      newMain.style.display = null;\n      // eslint-disable-next-line no-use-before-define\n      attachEventListners(newMain);\n      return true;\n    }\n\n    const block = element.parentElement?.closest('.block[data-aue-resource]') || element?.closest('.block[data-aue-resource]');\n    if (block) {\n      const blockResource = block.getAttribute('data-aue-resource');\n      const newBlock = parsedUpdate.querySelector(`[data-aue-resource=\"${blockResource}\"]`);\n      if (newBlock) {\n        newBlock.style.display = 'none';\n        block.insertAdjacentElement('afterend', newBlock);\n        decorateButtons(newBlock);\n        decorateIcons(newBlock);\n        decorateBlock(newBlock);\n        decorateRichtext(newBlock);\n        await loadBlock(newBlock);\n        block.remove();\n        newBlock.style.display = null;\n        return true;\n      }\n    } else {\n      // sections and default content, may be multiple in the case of richtext\n      const newElements = parsedUpdate.querySelectorAll(`[data-aue-resource=\"${resource}\"],[data-richtext-resource=\"${resource}\"]`);\n      if (newElements.length) {\n        const { parentElement } = element;\n        if (element.matches('.section')) {\n          const [newSection] = newElements;\n          newSection.style.display = 'none';\n          element.insertAdjacentElement('afterend', newSection);\n          decorateButtons(newSection);\n          decorateIcons(newSection);\n          decorateRichtext(newSection);\n          decorateSections(parentElement);\n          decorateBlocks(parentElement);\n          await loadSections(parentElement);\n          element.remove();\n          newSection.style.display = null;\n        } else {\n          element.replaceWith(...newElements);\n          decorateButtons(parentElement);\n          decorateIcons(parentElement);\n          decorateRichtext(parentElement);\n        }\n        return true;\n      }\n    }\n  }\n\n  return false;\n}\n\nfunction attachEventListners(main) {\n  [\n    'aue:content-patch',\n    'aue:content-update',\n    'aue:content-add',\n    'aue:content-move',\n    'aue:content-remove',\n    'aue:content-copy',\n  ].forEach((eventType) => main?.addEventListener(eventType, async (event) => {\n    event.stopPropagation();\n    const applied = await applyChanges(event);\n    if (!applied) window.location.reload();\n  }));\n}\n\nattachEventListners(document.querySelector('main'));\n"],"names":["decorateRichtext","container","deleteInstrumentation","element","richtextResource","richtextProp","richtextFilter","richtextLabel","siblings","sibling","orphanElements","editable","orphanElement","group","observer","applyChanges","event","detail","resource","_b","_a","_e","_d","_c","_h","_g","_f","updates","_i","content","parsedUpdate","newMain","decorateMain","loadSections","attachEventListners","block","_j","blockResource","newBlock","decorateButtons","decorateIcons","decorateBlock","loadBlock","newElements","parentElement","newSection","decorateSections","decorateBlocks","main","eventType"],"mappings":"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"}